<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoring Timbangan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

  <header class="bg-gray-800 text-white p-4 shadow-md flex justify-between items-center">
    <h1 class="text-lg font-semibold tracking-wide">üìä Monitoring Timbang</h1>
    <a href="/logout" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm font-semibold">
      Logout
    </a>
  </header>


  <main class="flex-1 p-6 space-y-8">
    <!-- STATUS -->
    <div id="status-container" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>

    <!-- TABEL LOG -->
     <section class="bg-white rounded-xl shadow p-6">
      <h3 class="text-center text-lg font-semibold text-gray-700 mb-4">History Populate Log</h3>

      <div class="overflow-x-auto">
        <table id="logTable" class="display min-w-full text-sm border-collapse">
          <thead>
            <tr>
              <th>NOURUT1</th>
              <th>PLANT_ID</th>
              <th>AKSI</th>
              <th>LOG_TIME</th>
              <th>MESSAGE</th>
              <th>STATUS</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="bg-gray-800 text-white text-center py-2 text-sm">
    &copy; 2025 Sistem Monitoring Timbangan
  </footer>

  <script>
    function timeAgo(seconds) {
    if (seconds < 60) return `${seconds} detik lalu`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)} menit lalu`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)} jam lalu`;
      return `${Math.floor(seconds / 86400)} hari lalu`;
    }
    
    function loadStatus() {
      fetch('/api/status')
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('status-container');
          container.innerHTML = ''; // clear dulu
          Object.keys(data).forEach(pc => {
            const info = data[pc];
            const status = info.status;
            const color = status === "ONLINE" ? "text-green-600" : "text-red-600";
            const bg = status === "ONLINE" ? "bg-green-50" : "bg-red-50";
            const lastActive = info.last_seen
              ? timeAgo(info.ago_seconds)
              : "Belum pernah aktif";

            const lastActiveText = status !== "ONLINE"
                ? `<p class="text-sm text-gray-500">Terakhir aktif: ${
                    info.last_seen ? timeAgo(info.ago_seconds) : "Belum pernah aktif"
                  }</p>`
                : "";  

            const card = `
              <div class="rounded-xl shadow-md p-6 text-center hover:shadow-lg transition ${bg}">
              <h2 class="text-lg font-bold mb-3 text-gray-700 uppercase">${pc}</h2>
              <div class="bg-gray-100 h-40 flex items-center justify-center rounded-lg border border-gray-300 mb-4">
                <i class="fa-solid fa-desktop text-6xl ${color}"></i>
              </div>
              <p class="font-semibold text-gray-700 mb-1">
                STATUS: <span class="${color} font-bold">${status}</span>
              </p>
              ${lastActiveText}
            </div>`;
            container.innerHTML += card;
          });
        })
        .catch(error => {
          console.error('Gagal memuat status:', error);
          const container = document.getElementById('status-container');
          container.innerHTML = `
            <div class="rounded-xl shadow-md p-6 text-center bg-red-50 text-red-600">
              <h2 class="text-lg font-bold mb-3">Gagal Memuat Data</h2>
              <p class="mb-2">Tidak dapat terhubung ke server atau data API bermasalah.</p>
              <p class="text-sm text-gray-500">${error.message}</p>
            </div>`;
        });
    }

    function loadLogs() {
      $('#logTable').DataTable({
        ajax: '/api/logs',
        destroy: true,
        columns: [
          { data: 'NOURUT1' },
          { data: 'PLANT_ID' },
          { data: 'AKSI',
            render: function (data) {
                if (!data) return `<span class="text-gray-400">-</span>`;
                return `<span class="px-2 py-1 text-xs font-semibold rounded-md bg-gray-100 text-gray-700">${data}</span>`;
            }
          },
          { data: 'LOG_TIME' },
          { data: 'MESSAGE' },
          {
            data: 'STATUS',
            render: function (data) {
              if (!data) return `<span class="text-gray-400">-</span>`;
              const status = data.toUpperCase();
              let colorClass = "bg-gray-100 text-gray-700";
              if (status === "SUCCESS") colorClass = "bg-green-100 text-green-700";
              else if (status === "FAILED") colorClass = "bg-red-100 text-red-700";
              else if (status === "PENDING") colorClass = "bg-yellow-100 text-yellow-700";
              return `<span class="px-2 py-1 text-xs font-semibold rounded-md ${colorClass}">${status}</span>`;
            }
          }
        ],
        pageLength: 10,
        order: [[3, 'desc']],
        language: { search: "üîç Cari:" }
      });
    }

    loadStatus();
    loadLogs();
    setInterval(loadStatus, 20000);
    setInterval(loadLogs, 20000);
  </script>
</body>
</html>
