<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoring Timbangan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <style>
    /* Buat semua th yang punya class text-center benar-benar center */
    table#logTable th.text-center {
      text-align: center !important;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col">

  <header class="bg-gray-800 text-white p-4 shadow-md flex justify-between items-center">
    <a href="/" class="text-lg font-semibold tracking-wide">
      üìä Monitoring Timbang 12345678910
    </a>
    <a href="/logout" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-sm font-semibold">
      Logout
    </a>
  </header>


  <main class="flex-1 p-6 space-y-8">
    <!-- STATUS -->
    <div id="status-container" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>

    <!-- TABEL LOG -->
     <section class="bg-white rounded-xl shadow p-6">
      <h3 class="text-center text-lg font-semibold text-gray-700 mb-4">History Populate Log</h3>

      <div class="overflow-x-auto">
        <table id="logTable" class="display min-w-full text-sm border-collapse">
          <thead>
            <tr>
              <th class="text-center">NOURUT1</th>
              <th class="text-center">PLANT_ID</th>
              <th class="text-center">AKSI</th>
              <th class="text-center">PC NAME</th>
              <th class="text-center">LOG_TIME</th>
              <th class="text-center">STATUS</th>
              <th class="text-center">MESSAGE</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="bg-gray-800 text-white text-center py-2 text-sm">
    &copy; 2025 Sistem Monitoring Timbangan
  </footer>

  <script>
    function timeAgo(seconds) {
    if (seconds < 60) return `${seconds} detik lalu`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)} menit lalu`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)} jam lalu`;
      return `${Math.floor(seconds / 86400)} hari lalu`;
    }
    
    function loadStatus() {
      fetch('/api/status')
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('status-container');
          container.innerHTML = '';
          Object.keys(data).forEach(pc => {
            const info = data[pc];
            const status = info.status;
            const color = status === "ONLINE" ? "text-green-600" : "text-red-600";
            const bg = status === "ONLINE" ? "bg-green-50" : "bg-red-50";
            const lastActiveText = status !== "ONLINE"
              ? `<p class="text-sm text-gray-500">Terakhir aktif: ${
                  info.last_seen ? timeAgo(info.ago_seconds) : "Belum pernah aktif"
                }</p>`
              : "";

            const card = `
              <div class="rounded-xl shadow-md p-6 text-center hover:shadow-lg transition ${bg}">
                <div class="flex justify-between items-center mb-3">
                  <h2 class="text-lg font-bold text-gray-700 uppercase">${pc}</h2>
                  <button onclick="refreshLogs('${pc}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs px-3 py-1 rounded-md flex items-center gap-1">
                    <i class="fa-solid fa-rotate-right"></i> Refresh
                  </button>
                </div>
                <div class="bg-gray-100 h-40 flex items-center justify-center rounded-lg border border-gray-300 mb-4">
                  <i class="fa-solid fa-desktop text-6xl ${color}"></i>
                </div>
                <p class="font-semibold text-gray-700 mb-1">
                  STATUS: <span class="${color} font-bold">${status}</span>
                </p>
                ${lastActiveText}
              </div>`;
            container.innerHTML += card;
          });
        })
        .catch(error => {
          console.error('Gagal memuat status:', error);
          const container = document.getElementById('status-container');
          container.innerHTML = `
            <div class="rounded-xl shadow-md p-6 text-center bg-red-50 text-red-600">
              <h2 class="text-lg font-bold mb-3">Gagal Memuat Data</h2>
              <p class="mb-2">Tidak dapat terhubung ke server atau data API bermasalah.</p>
              <p class="text-sm text-gray-500">${error.message}</p>
            </div>`;
        });
    }


    function loadLogs() {
      $('#logTable').DataTable({
        ajax: '/api/logs',
        destroy: true,
        columns: [
          { data: 'NOURUT1' },
          { data: 'PLANT_ID' },
          { data: 'AKSI',
            render: function (data) {
                if (!data) return `<span class="text-gray-400">-</span>`;
                let textColor = 'text-gray-700'; // default
                switch (data.toUpperCase()) {
                  case 'DELETE':
                    textColor = 'text-red-600';
                    break;
                  case 'UPDATE':
                    textColor = 'text-yellow-600';
                    break;
                  case 'INSERT':
                    textColor = 'text-green-600';
                    break;
                }
                return `<span class="px-2 py-1 text-xs font-semibold rounded-md bg-gray-100 ${textColor}">${data}</span>`;
            }
          },
          { data: 'PC_NAME',
            render: function (data) {
              if (!data) return `<span class="text-gray-400">-</span>`;
              const pcName = data.toUpperCase()
              return `<span class="uppercase">${pcName}</span>`
            }
           },
          { data: 'LOG_TIME' },          
          {
            data: 'STATUS',
            render: function (data) {
              if (!data) return `<span class="text-gray-400">-</span>`;
              const status = data.toUpperCase();
              let colorClass = "bg-gray-100 text-gray-700";
              if (status === "SUCCESS") colorClass = "bg-green-100 text-green-700";
              else if (status === "FAILED") colorClass = "bg-red-100 text-red-700";
              else if (status === "PENDING") colorClass = "bg-yellow-100 text-yellow-700";
              return `<span class="px-2 py-1 text-xs font-semibold rounded-md ${colorClass}">${status}</span>`;
            }
          },
          { data: 'MESSAGE' },
        ],
        // ‚¨á Tambahkan bagian ini untuk mengatur align center
        columnDefs: [
          { targets: [0, 1, 2, 3, 4, 5, 6], className: 'text-center' } // 2 = AKSI, 3 = PC_NAME, 5 = STATUS
        ],
        pageLength: 25,
        order: [[3, 'desc']],
        language: { search: "üîç Cari:" }
      });
    }

    function refreshLogs(pc_name) {
      console.log(`üîÑ Refresh log untuk: ${pc_name}`);
      $('#logTable').DataTable({
        ajax: `/api/logs?pc_name=${pc_name}`,
        destroy: true,
        columns: [
          { data: 'NOURUT1' },
          { data: 'PLANT_ID' },
          { data: 'AKSI',
            render: function (data) {
              if (!data) return `<span class="text-gray-400">-</span>`;
              let textColor = 'text-gray-700'; // default
              switch (data.toUpperCase()) {
                case 'DELETE':
                  textColor = 'text-red-600';
                  break;
                case 'UPDATE':
                  textColor = 'text-yellow-600';
                  break;
                case 'INSERT':
                  textColor = 'text-green-600';
                  break;
              }
              return `<span class="px-2 py-1 text-xs font-semibold rounded-md bg-gray-100 ${textColor}">${data}</span>`;
            }
          },
          { data: 'PC_NAME',
            render: function (data) {
              if (!data) return `<span class="text-gray-400">-</span>`;
              const pcName = data.toUpperCase()
              return `<span class="uppercase">${pcName}</span>`
            }
          },
          { data: 'LOG_TIME' },
          {
            data: 'STATUS',
            render: function (data) {
              if (!data) return `<span class="text-gray-400">-</span>`;
              const status = data.toUpperCase();
              let colorClass = "bg-gray-100 text-gray-700";
              if (status === "SUCCESS") colorClass = "bg-green-100 text-green-700";
              else if (status === "FAILED") colorClass = "bg-red-100 text-red-700";
              else if (status === "PENDING") colorClass = "bg-yellow-100 text-yellow-700";
              return `<span class="px-2 py-1 text-xs font-semibold rounded-md ${colorClass}">${status}</span>`;
            }
          },
          { data: 'MESSAGE' }
        ],
        columnDefs: [
          { targets: [0, 1, 2, 3, 4, 5, 6], className: 'text-center' } // 2 = AKSI, 3 = PC_NAME, 5 = STATUS
        ],
        pageLength: 25,
        order: [[3, 'desc']],
        language: { search: "üîç Cari:" }
      });
    }

    loadStatus();
    loadLogs();
    setInterval(loadStatus, 20000);
    setInterval(loadLogs, 600000); // update all status log per 10 menit
  </script>
</body>
</html>
